# ============================================================================
# Docker Compose para Renzzo Eléctricos - Producción
# ============================================================================

version: '3.9'

services:
  # ==========================================================================
  # BASE DE DATOS MySQL 8.0
  # ==========================================================================
  db:
    image: mysql:8.0
    container_name: renzzoelectricos_db
    restart: always
    environment:
      MYSQL_DATABASE: ${DATABASE_NAME:-renzzoelectricos_db}
      MYSQL_USER: ${DATABASE_USER:-renzzo_admin}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD:-RenzzoEl3ctr!c0s2024#Secure}
      MYSQL_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD:-R00tRenzz0!2024#MySQL}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    volumes:
      # Persistir datos de la base de datos
      - mysql_data:/var/lib/mysql
      # Configuración personalizada de MySQL
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
      # Backup automático
      - ./backups/mysql:/backups
    ports:
      - "${DATABASE_PORT:-3306}:3306"
    networks:
      - renzzo_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_ROOT_PASSWORD:-R00tRenzz0!2024#MySQL}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --max_connections=200
      - --max_allowed_packet=256M

  # ==========================================================================
  # APLICACIÓN DJANGO
  # ==========================================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: renzzoelectricos_web
    restart: always
    env_file:
      - .env
    environment:
      # Configuración de Django
      DEBUG: ${DEBUG:-False}
      SECRET_KEY: ${SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-*}
      
      # Configuración de Base de Datos
      DATABASE_ENGINE: django.db.backends.mysql
      DATABASE_NAME: ${DATABASE_NAME:-renzzoelectricos_db}
      DATABASE_USER: ${DATABASE_USER:-renzzo_admin}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-RenzzoEl3ctr!c0s2024#Secure}
      DATABASE_HOST: db
      DATABASE_PORT: 3306
      
      # Superusuario (solo se crea si no existe)
      DJANGO_SUPERUSER_USERNAME: ${DJANGO_SUPERUSER_USERNAME:-admin}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL:-admin@renzzoelectricos.com}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD:-Admin123!}
    volumes:
      # Código de la aplicación (solo para desarrollo, comentar en producción)
      # - .:/app
      # Archivos estáticos y media (persistentes)
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - logs_volume:/app/logs
    ports:
      - "5018:8000"  # Puerto 5018 expuesto para Cloudflare Tunnel → renzzoelectricos.com
    networks:
      - renzzo_network
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  #   image: nginx:1.25-alpine
  #   container_name: renzzoelectricos_nginx
  #   restart: always
  #   ports:
  #     - "${NGINX_HTTP_PORT:-80}:80"
  #     - "${NGINX_HTTPS_PORT:-443}:443"
  #   volumes:
  #     # Configuración de Nginx
  #     - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
  #     # Archivos estáticos y media
  #     - static_volume:/app/staticfiles:ro
  #     - media_volume:/app/media:ro
  #     # Certificados SSL (si se usan)
  #     - ./docker/nginx/ssl:/etc/nginx/ssl:ro
  #     # Logs de Nginx
  #     - logs_volume:/var/log/nginx
  #   networks:
  #     - renzzo_network
  #   depends_on:
  #     - web
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # ==========================================================================
  # REDIS - Cache y Cola de Tareas (Opcional)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: renzzoelectricos_redis
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-RenzzoR3d!s2024}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - renzzo_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

# ============================================================================
# VOLÚMENES PERSISTENTES
# ============================================================================
volumes:
  mysql_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  logs_volume:
    driver: local
  redis_data:
    driver: local

# ============================================================================
# RED INTERNA
# ============================================================================
networks:
  renzzo_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
