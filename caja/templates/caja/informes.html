{% extends 'dashboard/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}
    {% trans "Informes de Caja" %} | {{ block.super }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'caja/css/informes.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}

{% block page_title %}Informes de Caja{% endblock %}

{% block content %}
<div class="informes-caja-container">
    <!-- Header -->
    <div class="informes-header">
        <div class="header-content">
            <div class="header-title">
                <i class="bi bi-graph-up-arrow"></i>
                <h1>Informes de Caja</h1>
            </div>
            <div class="header-subtitle">
                <p>Análisis completo de movimientos, arqueos y flujo de efectivo</p>
            </div>
        </div>
    </div>

    <!-- Filtros de Fecha -->
    <div class="filtros-container">
        <div class="filtros-card">
            <div class="filtros-header">
                <i class="bi bi-calendar-range"></i>
                <h3>Filtrar por Periodo</h3>
            </div>
            <div class="filtros-content">
                <div class="filtros-rapidos">
                    <button class="btn-filtro active" data-filtro="ultima_semana">
                        <i class="bi bi-calendar-week"></i>
                        Última Semana
                    </button>
                    <button class="btn-filtro" data-filtro="ultimos_30_dias">
                        <i class="bi bi-calendar-month"></i>
                        Últimos 30 Días
                    </button>
                    <button class="btn-filtro" data-filtro="ultimos_2_meses">
                        <i class="bi bi-calendar2"></i>
                        Últimos 2 Meses
                    </button>
                    <button class="btn-filtro" data-filtro="ultimos_3_meses">
                        <i class="bi bi-calendar3"></i>
                        Últimos 3 Meses
                    </button>
                    <button class="btn-filtro" data-filtro="dia_actual">
                        <i class="bi bi-calendar-day"></i>
                        Hoy
                    </button>
                    <button class="btn-filtro" data-filtro="dia_anterior">
                        <i class="bi bi-calendar-minus"></i>
                        Ayer
                    </button>
                </div>
                <div class="filtros-personalizado">
                    <div class="fecha-input-group">
                        <label>
                            <i class="bi bi-calendar-event"></i>
                            Desde
                        </label>
                        <input type="date" id="fechaDesde" class="fecha-input">
                    </div>
                    <div class="fecha-input-group">
                        <label>
                            <i class="bi bi-calendar-check"></i>
                            Hasta
                        </label>
                        <input type="date" id="fechaHasta" class="fecha-input">
                    </div>
                    <button id="btnAplicarRango" class="btn-aplicar-rango">
                        <i class="bi bi-search"></i>
                        Aplicar Rango
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance General -->
    <div class="seccion-balance">
        <div class="seccion-header">
            <div class="seccion-title">
                <i class="bi bi-wallet2"></i>
                <h2>Balance General</h2>
            </div>
            <div class="periodo-actual" id="periodoBalance">
                <i class="bi bi-clock-history"></i>
                <span>Última Semana</span>
            </div>
        </div>

        <div class="balance-cards">
            <div class="balance-card card-guardado">
                <div class="card-icon">
                    <i class="bi bi-safe2"></i>
                </div>
                <div class="card-content">
                    <h3>Total Dinero Guardado</h3>
                    <p class="card-value" id="totalGuardado">$ 0</p>
                    <span class="card-label">Dinero guardado fuera de caja</span>
                </div>
            </div>

            <div class="balance-card card-ingresos">
                <div class="card-icon">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
                <div class="card-content">
                    <h3>Total Ingresos</h3>
                    <p class="card-value" id="totalIngresos">$ 0</p>
                    <span class="card-label">Suma de entradas de efectivo</span>
                </div>
            </div>

            <div class="balance-card card-egresos">
                <div class="card-icon">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
                <div class="card-content">
                    <h3>Total Egresos</h3>
                    <p class="card-value" id="totalEgresos">$ 0</p>
                    <span class="card-label">Suma de salidas de efectivo</span>
                </div>
            </div>

            <div class="balance-card card-flujo">
                <div class="card-icon">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div class="card-content">
                    <h3>Flujo Neto</h3>
                    <p class="card-value" id="flujoNeto">$ 0</p>
                    <span class="card-label">Ingresos - Egresos</span>
                </div>
            </div>

            <div class="balance-card card-stats">
                <div class="card-icon">
                    <i class="bi bi-calculator"></i>
                </div>
                <div class="card-content">
                    <h3>Estadísticas</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Cajas cerradas:</span>
                            <span class="stat-value" id="numCajas">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Promedio diferencia:</span>
                            <span class="stat-value" id="promedioDif">$ 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Arqueos -->
    <div class="seccion-arqueos">
        <div class="seccion-header">
            <div class="seccion-title">
                <i class="bi bi-journal-text"></i>
                <h2>Historial de Arqueos de Caja</h2>
            </div>
            <div class="arqueos-info">
                <span id="infoArqueos">Mostrando últimas 5 cajas</span>
            </div>
        </div>

        <div class="tabla-container">
            <div id="loadingArqueos" class="loading-spinner" style="display: none;">
                <i class="bi bi-arrow-repeat spin"></i>
                <p>Cargando datos...</p>
            </div>
            <div class="table-responsive">
                <table class="tabla-arqueos">
                    <thead>
                        <tr>
                            <th title="Número único de identificación de la caja"><i class="bi bi-hash"></i> ID</th>
                            <th title="Nombre del usuario que manejó la caja"><i class="bi bi-person"></i> Cajero</th>
                            <th title="Fecha y hora en que se abrió la caja"><i class="bi bi-calendar-check"></i> Apertura</th>
                            <th title="Fecha y hora en que se cerró la caja"><i class="bi bi-calendar-x"></i> Cierre</th>
                            <th title="Dinero con el que se inició la caja"><i class="bi bi-coin"></i> Saldo Inicial</th>
                            <th title="Total de ingresos de efectivo durante el turno"><i class="bi bi-arrow-down"></i> Entradas</th>
                            <th title="Total de salidas de efectivo durante el turno"><i class="bi bi-arrow-up"></i> Salidas</th>
                            <th title="Saldo que debería haber según el sistema (Inicial + Entradas - Salidas)"><i class="bi bi-calculator"></i> Saldo Teórico</th>
                            <th title="Dinero contado físicamente al cerrar la caja"><i class="bi bi-cash"></i> Saldo Real</th>
                            <th title="Diferencia entre lo contado y lo que debería haber (positivo=sobrante, negativo=faltante)"><i class="bi bi-exclamation-triangle"></i> Diferencia</th>
                            <th title="Ver detalles completos de esta caja"><i class="bi bi-eye"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaArqueosBody">
                        <tr>
                            <td colspan="11" class="text-center">
                                <i class="bi bi-inbox"></i>
                                <p>No hay datos para mostrar</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            <div class="paginacion" id="paginacionArqueos" style="display: none;">
                <button class="btn-pag" id="btnPagAnterior" disabled>
                    <i class="bi bi-chevron-left"></i>
                    Anterior
                </button>
                <div class="pag-info">
                    <span>Página <strong id="pagActual">1</strong> de <strong id="pagTotal">1</strong></span>
                    <span class="sep">|</span>
                    <span>Total: <strong id="totalRegistros">0</strong> registros</span>
                </div>
                <button class="btn-pag" id="btnPagSiguiente" disabled>
                    Siguiente
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Flujo de Efectivo Detallado -->
    <div class="seccion-flujo">
        <div class="seccion-header">
            <div class="seccion-title">
                <i class="bi bi-cash-coin"></i>
                <h2>Flujo de Efectivo Detallado</h2>
            </div>
            <div class="periodo-actual" id="periodoFlujo">
                <i class="bi bi-clock-history"></i>
                <span>Última Semana</span>
            </div>
        </div>

        <div class="flujo-content">
            <div class="flujo-resumen">
                <div class="flujo-card flujo-ingresos">
                    <div class="flujo-header">
                        <i class="bi bi-arrow-down-circle-fill"></i>
                        <h3>Ingresos Totales</h3>
                    </div>
                    <p class="flujo-total" id="flujoTotalIngresos">$ 0</p>
                    <div class="flujo-desglose" id="flujoIngresosDesglose">
                        <p class="no-data">Sin movimientos</p>
                    </div>
                </div>

                <div class="flujo-card flujo-egresos">
                    <div class="flujo-header">
                        <i class="bi bi-arrow-up-circle-fill"></i>
                        <h3>Egresos Totales</h3>
                    </div>
                    <p class="flujo-total" id="flujoTotalEgresos">$ 0</p>
                    <div class="flujo-desglose" id="flujoEgresosDesglose">
                        <p class="no-data">Sin movimientos</p>
                    </div>
                </div>
            </div>

            <div class="flujo-resultado">
                <div class="resultado-card" id="resultadoCard">
                    <div class="resultado-icon">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <div class="resultado-content">
                        <h3>Resultado del Periodo</h3>
                        <p class="resultado-valor" id="flujoResultado">$ 0</p>
                        <span class="resultado-label" id="flujoResultadoLabel">Flujo Neto (Ingresos - Egresos)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle de Caja -->
<div id="modalDetalleCaja" class="modal-detalle" style="display: none;">
    <div class="modal-detalle-overlay"></div>
    <div class="modal-detalle-content">
        <div class="modal-detalle-header">
            <h2><i class="bi bi-box-seam"></i> Detalle de Caja <span id="modalCajaId">#0</span></h2>
            <button class="modal-detalle-close" onclick="cerrarModalDetalle()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-detalle-body" id="modalDetalleBody">
            <div class="loading-modal">
                <i class="bi bi-arrow-repeat spin"></i>
                <p>Cargando información...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'caja/js/informes.js' %}"></script>
{% endblock %}
